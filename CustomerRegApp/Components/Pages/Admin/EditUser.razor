@page "/admin/edit/{UserId:int}"
@using CustomerRegApp.Models
@using CustomerRegApp.Services
@attribute [Authorize(Roles = "Admin")]
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject NavigationManager Navigation

<h3>Edit User</h3>

@if (User == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="User" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        
        <div class="mb-3">
             <label>Username</label>
             <InputText class="form-control" @bind-Value="User.Username" disabled />
        </div>
        <div class="mb-3">
             <label>Email</label>
             <InputText class="form-control" @bind-Value="User.Gmail" />
        </div>
        <div class="mb-3">
             <label>First Name</label>
             <InputText class="form-control" @bind-Value="User.FirstName" />
        </div>
        <div class="mb-3">
             <label>Monthly Income</label>
             <InputNumber class="form-control" @bind-Value="User.MonthlyIncome" />
        </div>
        
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
    </EditForm>
}

@code {
    [Parameter]
    public int UserId { get; set; }

    private UserEntity? User;

    protected override async Task OnInitializedAsync()
    {
        var allUsers = await AuthService.GetAllUsersAsync();
        User = allUsers.FirstOrDefault(u => u.Id == UserId);
        
        if (User == null)
        {
            Navigation.NavigateTo("/admin/dashboard");
        }
    }

    private async Task HandleSubmit()
    {
        if (User != null)
        {
            await AuthService.UpdateUserAsync(User);
            Navigation.NavigateTo("/admin/dashboard");
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/admin/dashboard");
    }
}
